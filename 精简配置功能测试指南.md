# 精简配置功能测试指南

## 功能说明

新用户注册时，只会初始化以下核心配置：

### 语音识别（ASR）- 3个
- FunASR语音识别
- FunASR服务器
- 腾讯语音识别

### 大语言模型（LLM）- 1个
- MinimaxLLM

### 语音合成（TTS）- 1个
- Minimax流式语音合成

### 其他类型（全部保留）
- Memory（记忆模型）
- VAD（语音活动检测）
- Intent（意图识别）
- VLLM（视觉语言模型）
- Voiceprint（声纹）

---

## 测试步骤

### 步骤1：注册新用户

1. 访问：http://47.103.24.213:8002
2. 点击"注册新用户"按钮
3. 填写注册信息：
   - 用户名：test_user5（或其他未使用的用户名）
   - 密码：设置一个密码
   - 邮箱：可选
4. 完成图形验证码
5. 点击"注册"按钮

### 步骤2：登录新用户

1. 使用刚才注册的账号登录
2. 进入"模型配置"页面

### 步骤3：验证配置数量

**预期结果：**

新用户应该看到约10个配置（而不是62个）

| 模型类型 | 预期数量 | 模型名称 |
|---------|---------|---------|
| ASR | 3个 | FunASR语音识别、FunASR服务器、腾讯语音识别 |
| LLM | 1个 | MinimaxLLM |
| TTS | 1个 | Minimax流式语音合成 |
| Memory | 1-3个 | mem0ai、mem_local_short、nomem |
| VAD | 1个 | SileroVAD |
| Intent | 1-2个 | intent_llm、function_call、nointent |
| VLLM | 0-1个 | （如果有） |

**总计：约8-12个配置**

### 步骤4：检查配置内容

1. 点击任意配置的"编辑"按钮
2. **验证敏感信息已清空：**
   - api_key 应该为空
   - url 应该为空
   - group_id 应该为空
   - access_token 应该为空

### 步骤5：对比admin用户

1. 退出当前用户
2. 使用admin账号登录
3. 进入"模型配置"页面
4. **验证：**
   - admin应该看到约62个配置
   - admin的配置包含API密钥等信息

---

## 查看日志验证

### 查看用户初始化日志

```bash
# 注册新用户后立即查看日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -A 5 "initUserModelConfigs"
```

**预期日志输出：**

```
开始为用户 <userId> 初始化默认模型配置
从超级管理员 admin (ID:<adminId>) 复制配置
找到 62 个模板配置，开始过滤并复制
过滤了 XX 个配置，将复制 XX 个配置
成功为用户 <userId> 复制了 XX 个配置
```

### 查看详细的过滤日志

```bash
# 查看哪些配置被过滤了
sudo docker logs xiaozhi-esp32-server-web --tail 200 | grep -i "过滤"
```

---

## 数据库验证

### 查询新用户的配置数量

```bash
# 替换 <新用户ID> 为实际的用户ID
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
SELECT 
    model_type,
    COUNT(*) as count,
    GROUP_CONCAT(model_name SEPARATOR ', ') as models
FROM ai_model_config 
WHERE creator = <新用户ID>
GROUP BY model_type;
"
```

**预期输出示例：**

```
model_type  count  models
ASR         3      FunASR语音识别, FunASR服务器, 腾讯语音识别
LLM         1      MinimaxLLM
TTS         1      Minimax流式语音合成
Memory      2      mem0ai, nomem
VAD         1      SileroVAD
Intent      2      intent_llm, function_call
```

### 查询所有用户的配置数量对比

```bash
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
SELECT 
    u.username,
    COUNT(c.id) as config_count
FROM sys_user u 
LEFT JOIN ai_model_config c ON u.id = c.creator 
GROUP BY u.id, u.username 
ORDER BY u.create_date DESC;
"
```

**预期输出示例：**

```
username     config_count
test_user5   10          <-- 新用户（精简配置）
test_user4   62          <-- 旧用户（更新前注册）
admin        62          <-- 管理员（完整配置）
```

---

## 功能特性验证

### 验证1：ASR只有3个

```bash
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
SELECT model_name, model_code 
FROM ai_model_config 
WHERE creator = <新用户ID> AND (model_type = 'ASR' OR model_type = 'asr');
"
```

**预期：只显示3个ASR配置**

### 验证2：LLM只有1个

```bash
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
SELECT model_name, model_code 
FROM ai_model_config 
WHERE creator = <新用户ID> AND (model_type = 'LLM' OR model_type = 'llm');
"
```

**预期：只显示MinimaxLLM**

### 验证3：TTS只有1个

```bash
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
SELECT model_name, model_code 
FROM ai_model_config 
WHERE creator = <新用户ID> AND (model_type = 'TTS' OR model_type = 'tts');
"
```

**预期：只显示Minimax流式语音合成**

### 验证4：敏感信息已清空

```bash
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
SELECT 
    model_name,
    JSON_EXTRACT(config_json, '$.api_key') as api_key,
    CHAR_LENGTH(JSON_UNQUOTE(JSON_EXTRACT(config_json, '$.api_key'))) as key_length
FROM ai_model_config 
WHERE creator = <新用户ID> AND model_name = 'MinimaxLLM';
"
```

**预期：api_key为空字符串，key_length为0**

---

## 常见问题

### Q1：新用户看到的配置数量不对？

**检查步骤：**

1. 查看日志确认初始化是否成功
   ```bash
   sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep "initUserModelConfigs"
   ```

2. 检查数据库中是否有配置
   ```bash
   sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "SELECT COUNT(*) FROM ai_model_config WHERE creator = <新用户ID>;"
   ```

3. 确认代码已部署
   ```bash
   sudo docker logs xiaozhi-esp32-server-web --tail 20
   ```

### Q2：敏感信息未清空？

**检查步骤：**

1. 查看清空日志
   ```bash
   sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep "清空敏感字段"
   ```

2. 手动清空（紧急修复）
   ```bash
   sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 xiaozhi_esp32_server -e "
   UPDATE ai_model_config 
   SET config_json = JSON_SET(config_json, '$.api_key', '') 
   WHERE creator = <新用户ID>;
   "
   ```

### Q3：老用户是否受影响？

**答：不受影响**

- 这个功能只影响新注册的用户
- 已存在的用户配置保持不变
- admin的配置完全不受影响

### Q4：如何修改默认配置列表？

**步骤：**

1. 编辑文件：
   ```
   /home/moshu/xiaozhi-esp32-server/main/manager-api/src/main/java/xiaozhi/modules/sys/service/impl/UserInitServiceImpl.java
   ```

2. 修改常量：
   ```java
   private static final List<String> DEFAULT_ASR_MODELS = Arrays.asList(
       "FunASR",           // 可以添加或删除
       "FunASRServer",
       "TencentASR"
   );
   ```

3. 重新编译和部署：
   ```bash
   cd /home/moshu/xiaozhi-esp32-server/main/manager-api
   mvn clean package -DskipTests
   
   cd /home/moshu/xiaozhi-esp32-server/main
   sudo docker build -t xiaozhi-web-local:latest -f Dockerfile.web-local .
   
   cd /home/moshu/xiaozhi-esp32-server/main/xiaozhi-server
   sudo docker compose -f docker-compose_all.yml up -d xiaozhi-esp32-server-web
   ```

---

## 成功标准

✅ **测试通过条件：**

1. 新用户配置数量约10个（不是62个）
2. ASR只有3个指定模型
3. LLM只有MinimaxLLM
4. TTS只有Minimax流式语音合成
5. 所有敏感信息（api_key、url等）为空
6. Memory、VAD、Intent等辅助配置正常
7. 老用户配置不受影响
8. 日志显示正确的过滤信息

---

## 回滚方案

如果需要回滚到之前的版本（所有配置都复制）：

1. **修改代码**
   ```java
   // 在 UserInitServiceImpl.java 中
   // 将 shouldCopyConfig() 方法改为：
   private boolean shouldCopyConfig(ModelConfigEntity config) {
       return true;  // 复制所有配置
   }
   ```

2. **重新部署**
   ```bash
   cd /home/moshu/xiaozhi-esp32-server/main/manager-api
   mvn clean package -DskipTests
   
   cd /home/moshu/xiaozhi-esp32-server/main
   sudo docker build -t xiaozhi-web-local:latest -f Dockerfile.web-local .
   
   cd /home/moshu/xiaozhi-esp32-server/main/xiaozhi-server
   sudo docker compose -f docker-compose_all.yml up -d xiaozhi-esp32-server-web
   ```

---

## 总结

这个功能让新用户注册后只获得核心的、必要的配置，简化了用户体验：

- **优点：**
  - 配置列表更简洁（10个 vs 62个）
  - 减少用户困惑
  - 关注核心功能
  - 降低系统负担

- **保持灵活性：**
  - 用户可以随时添加其他配置
  - 可以复制admin的配置
  - 可以自己创建新配置

